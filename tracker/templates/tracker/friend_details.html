{% extends 'tracker/base.html' %}
{% load static %}
{% block title %}Friend Details{% endblock %}

{% block content %}
<div class="card shadow p-4 mt-4">
    <h2 class="mb-0 fw-light">Shared Expenses with {{ friend.name }}</h2>

    {% if total_balance > 0.01 %} {# Use a small threshold #}
        <div class="alert alert-success bg-success-subtle text-success-emphasis border border-success border-opacity-10 rounded mt-3" role="alert">
            <strong>{{ friend.name }} owes you ₹{{ total_balance|floatformat:2 }}</strong>
        </div>
    {% elif total_balance < -0.01 %} {# Use a small threshold #}
        <div class="alert alert-danger bg-danger-subtle text-danger-emphasis border border-danger border-opacity-10 rounded mt-3" role="alert">
            <strong>You owe {{ friend.name }} ₹{{ total_balance|floatformat:2|cut:"-" }}</strong>
        </div>
    {% else %}
        <div class="alert alert-secondary bg-light text-muted border-0 rounded mt-3" role="alert"> {# Use secondary/light for settled #}
            <strong>You are all settled up.</strong>
        </div>
    {% endif %}

    <div class="mb-3 d-flex align-items-center">
        <a href="{% url 'add_expense_with_friend' friend.id %}" class="btn btn-primary btn-sm me-2">Add Expense</a> 
        <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#settleUpModal">
            Settle Up
        </button> 
    </div> 

    <hr>

    <h4 class="mb-0 fw-light">Expense List</h4><br>
    <table class="table table-hover">
        <thead class="table-light text-center">
            <tr>
                <th>Title</th>
                <th>Category</th>
                <th>Amount</th>
                <th>Paid By</th>
                <th>Date</th>
                <th>Balances</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for expense in expenses_page_obj %}
            <tr>
                <td class="text-center">{{ expense.title }}</td>
                <td class="text-center">{{ expense.category }}</td>
                <td class="text-center">₹{{ expense.amount }}</td>
                <td class="text-center">{{ expense.paid_by.name }}</td>
                <td class="text-center">{{ expense.date }}</td>
                <td class="text-center">
                    {% if expense.amount_owed > 0 %}
                        {{ friend.name }} owes you ₹{{ expense.amount_owed|floatformat:2 }}
                    {% elif expense.amount_owed < 0 %}
                        You owe {{ friend.name }} ₹{{ expense.amount_owed|floatformat:2|cut:"-" }}
                    {% else %}
                        Settled
                    {% endif %}
                </td>
                 
                <td class="text-center align-middle"> 
                    <form action="{% url 'delete_friend_expense' expense.id %}" method="POST" 
                    onsubmit="return confirm('Are you sure you want to delete this expense? This action cannot be undone.');" 
                    class="d-inline"> 
                    {% csrf_token %}
                    <button type="submit" class="btn btn-sm btn-outline-danger" title="Delete Expense">
                        <i class="fas fa-trash-alt"></i> {# Optional: Add trash icon #}
                    </button>
                    </form>
                        {# Add Edit button here later if needed #}
                </td>
            </tr>
            {% empty %}
                <tr>
                    <td colspan="7" class="text-center">No Expenses added</td>
                </tr>
            {% endfor %}
        </tbody>
    </table>

    <nav aria-label="Expenses navigation">
        <ul class="pagination justify-content-center">
            {% if expenses_page_obj.has_previous %}
                <li class="page-item"><a class="page-link" href="?page=1">&laquo; First</a></li>
                <li class="page-item"><a class="page-link" href="?page={{ expenses_page_obj.previous_page_number }}">Previous</a></li>
            {% endif %}

            <li class="page-item disabled">
                <span class="page-link">Page {{ expenses_page_obj.number }} of {{ expenses_page_obj.paginator.num_pages }}</span>
            </li>

            {% if expenses_page_obj.has_next %}
                <li class="page-item"><a class="page-link" href="?page={{ expenses_page_obj.next_page_number }}">Next</a></li>
                <li class="page-item"><a class="page-link" href="?page={{ expenses_page_obj.paginator.num_pages }}">Last &raquo;</a></li>
            {% endif %}
        </ul>
    </nav>

</div>

<div class="modal fade" id="settleUpModal" tabindex="-1" aria-labelledby="settleUpModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">

            <form action="{% url 'record_payment' friend.id %}" method="POST">
                {% csrf_token %}
                <input type="hidden" name="redirect_url" value="{{ request.path }}">

                <div class="modal-header">
                    <h5 class="modal-title" id="settleUpModalLabel">Record a Payment</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Record a payment made outside the app (e.g., cash, GPay).</p>

                    <div class="mb-3">
                        <label for="amount" class="form-label">Amount</label>
                        <input type="number" step="0.01" class="form-control" id="amount" name="amount" required>
                    </div>

                    <div class="mb-3">
                        <label for="payer" class="form-label">Who Paid?</label>
                        <select class="form-select" id="payer" name="payer" required>
                            <option value="{{ user.id }}">You ({{ user.name }})</option>
                            <option value="{{ friend.id }}">{{ friend.name }}</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Save Payment</button>
                    <button type="button" class="btn btn-outline-secondary me-md-2" data-bs-dismiss="modal">Cancel</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}