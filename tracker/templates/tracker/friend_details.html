{% extends 'tracker/base.html' %}
{% block title %}Friend Details{% endblock %}

{% block content %}
<div class="card shadow p-4 mt-4">
    <h2>{{ friend.name }}</h2>

    <div class="alert alert-info mt-3">
        {% if total_balance > 0 %}
            <strong>{{ friend.name }} owes you Rs {{ total_balance|floatformat:2 }}</strong>
        {% elif total_balance < 0 %}
            <strong>You owe {{ friend.name }} Rs {{ total_balance|floatformat:2|cut:"-" }}</strong>
        {% else %}
            <strong>You are all settled up.</strong>
        {% endif %}
    </div>

    <div class="mb-3">
        <a href="{% url 'add_expense_with_friend' friend.id %}" class="btn btn-primary mb-3">Add Expense</a> 
        <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#settleUpModal">
            Settle Up
        </button> 
    </div> 

    <hr>

    <h4>Expense List</h4>
    <table class="table table-bordered">
        <thead>
            <tr>
                <th>Date</th>
                <th>Title</th>
                <th>Category</th>
                <th>Description</th>
                <th>Amount</th>
                <th>Paid By</th>
                <th>Balances</th>
            </tr>
        </thead>
        <tbody>
            {% for expense in expenses %}
                <tr>
                    <td>{{ expense.date }}</td>
                    <td>{{ expense.title }}</td>
                    <td>{{ expense.category }}</td>
                    <td>{{ expense.description }}</td>
                    <td>₹{{ expense.amount }}</td>
                    <td>{{ expense.paid_by.name }}</td>
                    <td>
                        {% if expense.amount_owed > 0 %}
                            {{ friend.name }} owes you ₹{{ expense.amount_owed|floatformat:2 }}
                        {% elif expense.amount_owed < 0 %}
                            You owe {{ friend.name }} ₹{{ expense.amount_owed|floatformat:2|cut:"-" }}
                        {% else %}
                            Settled for this item
                        {% endif %}
                    </td> 
                </tr>
            {% empty %}
                <tr>
                    <td colspan="7" class="text-center">No Expenses added</td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="modal fade" id="settleUpModal" tabindex="-1" aria-labelledby="settleUpModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form action="{% url 'record_payment' friend.id %}" method="POST">
                {% csrf_token %}
                <div class="modal-header">
                    <h5 class="modal-title" id="settleUpModalLabel">Record a Payment</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Record a payment made outside the app (e.g., cash, GPay).</p>
                    
                    <div class="mb-3">
                        <label for="amount" class="form-label">Amount</label>
                        <input type="number" step="0.01" class="form-control" id="amount" name="amount" required>
                    </div>

                    <div class="mb-3">
                        <label for="payer" class="form-label">Who Paid?</label>
                        <select class="form-select" id="payer" name="payer" required>
                            <option value="{{ user.id }}">You ({{ user.name }})</option>
                            <option value="{{ friend.id }}">{{ friend.name }}</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">Save Payment</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}